<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>How do I Deploy a Rails 6 app to Amazon EC2? | Ogden Studios</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="How do I Deploy a Rails 6 app to Amazon EC2?" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Why I wrote this blog post" />
<meta property="og:description" content="Why I wrote this blog post" />
<link rel="canonical" href="http://localhost:4000/blog/tutorial/rails/aws/2019/01/30/how-do-i-deploy-a-rails-6-app-to-amazon-ec-2.html" />
<meta property="og:url" content="http://localhost:4000/blog/tutorial/rails/aws/2019/01/30/how-do-i-deploy-a-rails-6-app-to-amazon-ec-2.html" />
<meta property="og:site_name" content="Ogden Studios" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-01-30T00:00:00-07:00" />
<script type="application/ld+json">
{"headline":"How do I Deploy a Rails 6 app to Amazon EC2?","dateModified":"2019-01-30T00:00:00-07:00","datePublished":"2019-01-30T00:00:00-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/tutorial/rails/aws/2019/01/30/how-do-i-deploy-a-rails-6-app-to-amazon-ec-2.html"},"url":"http://localhost:4000/blog/tutorial/rails/aws/2019/01/30/how-do-i-deploy-a-rails-6-app-to-amazon-ec-2.html","description":"Why I wrote this blog post","@type":"BlogPosting","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="/stylesheets/ogden.css">
  <meta property="og:image" content="/img/FacebookBanner.jpg" />
  <!-- Google Suite Verification -->
  <meta name="google-site-verification" content="Ay267gjaK2dbcK9EuGzYKc0xKCC-cNH8tc4D-rc5D2U" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ogden Studios" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/"><img class="nav-brand" src="/img/ogden-transparent.png"></a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
            <a class="page-link" href="/projects">Projects</a>
            <a class="page-link" href="/experience">Experience</a>
            <a class="page-link" href="/skills">Skills</a>
            <a class="page-link" href="/blog">Blog</a>
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">How do I Deploy a Rails 6 app to Amazon EC2?</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2019-01-30T00:00:00-07:00" itemprop="datePublished">Jan 30, 2019
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="why-i-wrote-this-blog-post">Why I wrote this blog post</h2>

<p>I’ve been building Rails apps for some time now. On some projects, I’ve been fortunate enough to have a DevOps team to take care of production deploys to AWS. For smaller, personal projects, I’ve been mostly relying on <a href="https://heroku.com">Heroku</a> to deploy.</p>

<p>I love Heroku. They make an excellent product, and it’s great for quick prototypes and small hobby servers. But for more involved projects, the cost and lack of control don’t work for me. I figured it was time to start managing my own infrastructure.</p>

<p>I decided to learn how to deploy to EC2, and wrote this blog along the way.</p>

<p>Additionally, the <a href="https://edgeguides.rubyonrails.org/6_0_release_notes.html">Ruby on Rails 6 beta</a> just came out, and I wanted to spin up a demo project and check it out.</p>

<p>Seemed like deploying a shiny new Rails 6 project to an EC2 instance is a great way for me to level up, and I figured I could help others do the same and increase my own understanding by writing a blog post.</p>

<h2 id="who-should-read-this-blog-post">Who should read this blog post</h2>

<p>This blog posts assumes some prior knowledge of Ruby on Rails. I learned what I know from:</p>
<ul>
  <li><a href="https://www.railstutorial.org/book">The Michael Hartl Tutorial</a></li>
  <li><a href="https://www.youtube.com/watch?v=7-1HCWbu7iU&amp;list=PL23ZvcdS3XPLNdRYB_QyomQsShx59tpc-">12 Rails Apps in 12 Weeks by Mackenzie Childs</a></li>
</ul>

<p>It also assumes knowledge of command line interfaces, SSH, and git. Here are some good places to start for that:</p>
<ul>
  <li><a href="https://www.davidbaumgold.com/tutorials/command-line/">Getting around the Command Line</a></li>
  <li><a href="http://blog.robertelder.org/what-is-ssh/">What is SSH?</a></li>
  <li><a href="http://try.github.io/">Try Git</a></li>
</ul>

<h2 id="how-this-blog-post-works">How this blog post works</h2>

<p>I’ll be writing out each step of my process in creating a blank Rails 6 application and deploying it to a barebones EC2 instance. I will focus special attention on the steps that tripped me up as I performed them.</p>

<p>I’m going to use my actual commands, filepaths, and project names. That means you’ll likely need to do some substitution as you follow along, depending on your specific use case.</p>

<p>My environment:</p>
<ul>
  <li>MacBook Pro</li>
  <li>Visual Studio Code</li>
  <li>zsh</li>
</ul>

<p>So let’s get started!</p>

<h2 id="get-rails-6">Get Rails 6</h2>

<p>Assuming you already have ruby, bundler, and rails installed on your local dev machine, because you have some Ruby on Rails experience.</p>

<p>Get the latest rails gem(s).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~
local$ gem install rails --pre 
</code></pre></div></div>

<h2 id="create-a-rails-6-project">Create a Rails 6 project</h2>

<p>Then you need to make a new project with the Rails 6 beta</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/dev
local$ rails _6.0.0beta1_ new trackerr
local$ cd trackerr
</code></pre></div></div>

<p>An initial <code class="highlighter-rouge">bundle install</code> never hurts</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/dev/trackerr
local$ bundle install 
</code></pre></div></div>

<p>Check that it works</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/dev/trackerr
local$ rails s
</code></pre></div></div>

<p>You should see something like:</p>

<p><img src="/img/rails-6-ec2-tutorial-1/rails-6-success.png" alt="Rails 6 Default Index Screenshot" /></p>

<p>Nice, it works.</p>

<p>This is my favorite place for an init commit in git: It’s fresh, it’s new, it works. I haven’t broken anything yet.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/dev/trackerr
local$ git add . 
local$ git commit -m "init commit"
</code></pre></div></div>

<h2 id="push-to-github-or-other-similar-platform">Push to GitHub (or other similar platform).</h2>

<p>I use GitHub for my repositories, so YMMV, but I’m going to get this fresh Rails project checked into GitHub ASAP.</p>

<p><a href="https://help.github.com/articles/create-a-repo/">Here’s the GitHub doc for creating a new repository</a>, or you can follow along below:</p>

<ol>
  <li>Go to <a href="https://github.com" target="_blank" rel="noopener noreffer">https://github.com</a></li>
  <li>Sign in or sign up.</li>
  <li>Click the plus sign button</li>
  <li>Click <strong>New Repository</strong></li>
  <li>Name it <strong>trackerr</strong> (or whatever you’d like to name your project).</li>
  <li>Add a description. For my project, that description is: <strong>Full Suite State Legislation Tracker</strong></li>
  <li><a href="https://techcrunch.com/2019/01/07/github-free-users-now-get-unlimited-private-repositories/">GitHub allows unlimited private repos now</a>, but I’ll keep it public, because I love open source.</li>
  <li>Don’t initialize the repo, you’ve already got one on your machine.</li>
  <li>Follow the on-page instructions for pushing an existing repo from command line</li>
</ol>

<p>I use SSH keys for my GitHub access, and setting that up is beyond the scope of this blog post, but <a href="https://help.github.com/articles/adding-a-new-ssh-key-to-your-github-account/">here is a good guide on how to do that</a>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/dev/trackerr
local$ git remote add origin git@github.com:&lt;YOUR ADDRESS HERE&gt;
local$ git push -u origin master 
</code></pre></div></div>

<p>Voila, you’ve got a Rails 6 project installed on your machine and checked in to your GitHub.</p>

<h2 id="get-the-sample-page-ready">Get the sample page ready</h2>

<p>In order for your Rails app to actually work on the EC2 instance, you’ll need to set up a root path in your configuration, and a corresponding controller and view.</p>

<p>You can use the <a href="https://guides.rubyonrails.org/command_line.html">rails controller generator, if you like</a>, or you can add it yourself. Since this blog post doesn’t cover testing or assets or any of the other nice rails magic created in the controller generators, I’m going to just manually add the bare minimum here.</p>

<p>In your <code class="highlighter-rouge">config/routes</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/dev/trackerr/config/routes.rb 
root "pages#index"
</code></pre></div></div>

<p>In your <code class="highlighter-rouge">app/controllers</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/dev/trackerr/app/controllers/pages_controller.rb
class PagesController &lt; ApplicationController
    def index
    end
end 
</code></pre></div></div>

<p>And a corresponding view</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/dev/trackerr/app/views/pages/index.html.erb
&lt;h1&gt;You did it! Great job!&lt;/h1&gt;
</code></pre></div></div>

<p>Add your changes and push them up to git</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/dev/trackerr
local$ git add .
local$ git commit -m "add home page"
local$ git push 
</code></pre></div></div>

<p>Now your barebones Rails 6 app is just about ready to live on a server.</p>

<h2 id="set-up-your-amazon-ec2-instance">Set up your Amazon EC2 Instance</h2>

<p>Go to Amazon AWS Console</p>

<p><a href="https://console.aws.amazon.com/" target="_blank" rel="noopener norefferer">https://console.aws.amazon.com/</a></p>

<p>Sign in, or sign up.</p>

<p>Once you’re logged in and have an account ready to go, click <strong>Services</strong>.</p>

<p>In the dropdown menu, select <strong>EC2</strong> under the <strong>Compute</strong> menu.</p>

<p>On this new page, click <strong>Launch Instance</strong>.</p>

<p>Choose the <strong>Ubuntu Server 18.04 LTS (HVM), SSD Volume Type</strong>.</p>

<p>Click the <strong>Select</strong> button.</p>

<p>Since this is a starter project, I’m going to choose the t2.micro instance, eligible for the free tier.</p>

<p>Click <strong>Next: Configure Instance Details</strong> - nothing to change here, unless you want to.</p>

<p>Click <strong>Next: Add Storage</strong> - I’m going to keep the defaults here, as well, since this is really just a proof of concept kind of thing.</p>

<p>Click <strong>Next: Add Tags</strong> - again, nothing to go here.</p>

<p>Click <strong>Next: Configure Security Group</strong></p>

<ol>
  <li>Select the <strong>Create a new security group</strong> radio button</li>
  <li>There’s already an SSH open on port 22 to 0.0.0.0/0
    <ul>
      <li>Amazon will tell you this is insecure, and they’re right. This allows people to connect via SSH from anywhere on the internet. If you have the ability to lock down your own IP address, you should choose a restricted SSH set, and limit it to your IP. I won’t go into that, and for now we aren’t setting up anything sensitive enough to really go wrong here.</li>
    </ul>
  </li>
  <li>Next, add a new rule. Here’s what I created:</li>
</ol>

<p><img src="/img/rails-6-ec2-tutorial-1/ec2-security-group.png" alt="Image depicting Amazon EC2 sample security group" /></p>

<p>Security rule settings:</p>
<ul>
  <li>Type: <code class="highlighter-rouge">Custom TCP</code></li>
  <li>Protocol: <code class="highlighter-rouge">TCP</code></li>
  <li>Port Range: <code class="highlighter-rouge">80</code></li>
  <li>Source: <code class="highlighter-rouge">Custom: 0.0.0.0/0</code></li>
</ul>

<p>Keeping port 80 open to the world is desired behavior - you want anyone to be able to access your site once it’s live.</p>

<p>Click <strong>Review and Launch</strong></p>

<p>Confirm everything looks the way you want, and finally click <strong>Launch</strong>.</p>

<p>Amazon will ask you to select an existin gkey pari or create a new key pair. I’m assuming you either haven’t done this before (and therefore have no key pair), or, like me, are trying to set up a fully sandboxed Rails App. So let’s select <em>Create a new key pair</em>.</p>

<p>Name it. I’m naming mine <em>trackerr-key-pair</em></p>

<p>Click <strong>Download Key Pair</strong>.</p>

<p><img src="/img/rails-6-ec2-tutorial-1/key-pair-dialogue.png" alt="Image depicting Amazon EC2 Key Pair Dialogue" /></p>

<p>Save the file.</p>

<p>Click <strong>Launch Instances</strong>.</p>

<p>Once the instances launch, amazon will give you an option to view it (along with a lot of other helpful information you should check out).</p>

<p>I like to name my EC2 instances. If you click on the link provided by Amazon pointing to your instance, you can view your EC2 console.</p>

<p>Under the <strong>Name</strong> column, you can click the pencil icon to edit its name. I chose <em>Trackerr</em>. Here’s what my Resource Groups look like after that.</p>

<p><img src="/img/rails-6-ec2-tutorial-1/resource-groups.png" alt="Image depicting Amazon EC2 Resource Groups" /></p>

<p>Great! Now you’ve got a Rails App on your machine and in GitHub, and you have a plain EC2 instance running on AWS. It’s almost time to marry them together.</p>

<p>Before we get to that, though, let’s set up convenient access to the server.</p>

<p>First, find that <code class="highlighter-rouge">.pem</code> key file you downloaded from Amazon. I’m on a Mac + FireFox, so mine ended up in <code class="highlighter-rouge">~/Downloads</code></p>

<p>I personally like to keep these kinds of files in <code class="highlighter-rouge">~/server-keys</code> - which may or may not be great SecOps. I guess one day I’ll find out.</p>

<p>So go ahead and make a folder called <code class="highlighter-rouge">server-keys</code> (or whatever you like) and drop it in your home directory (or wherever you like).</p>

<p>You’ll need to make your key not publicly viewable. To make sure that’s the case, run</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/server-keys/
local$ chmod 400 trackerr-key-pair.pem
</code></pre></div></div>

<p>Then you’ll want to connect to your instance using its Public DNS.</p>

<p>The command looks like <code class="highlighter-rouge">ssh -i "tracker-key-pair.pem" ubuntu@some-dns.computer.amazon.aws</code> (not my actual address).</p>

<p>If you need a more specific command for your keypair name and DNS address, click the <strong>Connect</strong> button in the Amazon Resource Groups panel.</p>

<p>Make sure that all works. If so, you’re in good shape. At this point you:</p>

<ol>
  <li>Have a Rails 6 app on your computer/in GitHub.</li>
  <li>Have an Amazon EC2 instance running</li>
  <li>Have SSH access to your Amazon EC2 instance.</li>
</ol>

<p>Let’s make that SSH access even more convenient by setting up an alias. I use <a href="https://medium.com/swlh/power-up-your-terminal-using-oh-my-zsh-iterm2-c5a03f73a9fb">zsh and oh-my-zsh</a>, so I’m going to open up my .zshrc file.</p>

<p>In command line:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~
local$ vim .zshrc
</code></pre></div></div>

<p>I’m not great with <a href="https://www.openvim.com/">VIM</a>, but I’m learning, and I love it. You can edit this file using any text editor you like.</p>

<p>Everyone’s config is going to be different. Towards the bottom of my file, I’m going to add:</p>

<p><code class="highlighter-rouge">alias ssh_trackerr="ssh -i ~/server-keys/trackerr-key-pair.pem ubuntu@my-server-dns.something.com";</code></p>

<p>With the correct address in it.</p>

<p>Once you write and save to the zsh (or whatever shell) config, restart your shell. For me, it’s just:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~ 
local$ zsh 
</code></pre></div></div>

<p>Then I can run</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~ 
local$ ssh_trackerr
</code></pre></div></div>

<p>And I’m in.</p>

<p>Excellent, most of the pre-reqs are out of the way now.</p>

<p>Let’s start get our server ready to serve up a rails app.</p>

<p>I’m going to sandbox our rails app under a specific user account. I’ll need the user to have sudo privileges, so I’ll create a new sudo user by following <a href="https://www.digitalocean.com/community/tutorials/how-to-create-a-sudo-user-on-ubuntu-quickstart">these instructions</a>. You can follow along there or with this blog post.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># local
local$ ssh_trackerr 

# EC2
ubuntu$ sudo adduser trackerr-user
</code></pre></div></div>

<p>You’ll be given some prompts. First is for a new UNIX password. This will be the user’s password. Make it good, and I’d recommend using a password manager (Like <a href="https://keepass.info/help/base/firststeps.html">KeePass2</a>) to generate and store it for you.</p>

<p>Confirm the password. You can leave the next prompts blank if you like, or fill in the information asked of you. I’m leaving them blank.</p>

<p>Next we’ll need to use <code class="highlighter-rouge">usermod</code> command to add them to the sudo group</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
ubuntu$ sudo usermod -aG sudo trackerr-user
</code></pre></div></div>

<p>Test it out to make sure this works as expected. Use <code class="highlighter-rouge">su</code> to switch to the new user.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2 
ubuntu$ su - trackerr-user 
</code></pre></div></div>

<p>Now test that you can run sudo commands with something innocuous like</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ sudo apt-get update 
</code></pre></div></div>

<p>You’ll be prompted for that password again, enter it, and you should be good to go.</p>

<p>Now that we’ve sandboxed our rails user, given them sudo access, and updated our apt-get sources, we’ll want to install Ruby on Rails so we can run our app.</p>

<p>I’ll be following the instructions <a href="https://www.digitalocean.com/community/tutorials/how-to-install-ruby-on-rails-with-rbenv-on-ubuntu-18-04">here</a> - which you can follow, or you can follow along with me.</p>

<p>Update the package list</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ sudo apt update
</code></pre></div></div>

<p>Run the upgrades you can (not in DigitalOcean guide, but not a bad idea)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ sudo apt upgrade 
</code></pre></div></div>

<p>Then install the dependencies required to install Ruby:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2 
trackerr-user$ sudo apt install autoconf bison build-essential libssl-dev libyaml-dev libreadline6-dev zlib1g-dev libncurses5-dev libffi-dev libgdbm5 libgdbm-dev
</code></pre></div></div>

<p>Once those dependencies install, install rbenv. Clone the rbenv repo:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ git clone https://github.com/rbenv/rbenv.git ~/.rbenv
</code></pre></div></div>

<p>then, add ~/.rbenv/bin to your $PATH so you can use its CLI.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2 
trackerr-user$ echo 'export PATH="$HOME/.rbenv/bin:$PATH"' &gt;&gt; ~/.bashrc
</code></pre></div></div>

<p>Add this command to your bash profile so you can load rbenv automatically.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ echo 'eval "$(rbenv init -)"' &gt;&gt; ~/.bashrc
</code></pre></div></div>

<p>Restart bash to get those changes to apply.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ source ~/.bashrc 
</code></pre></div></div>

<p>Then we’ll install the ruby-build plugin to add <code class="highlighter-rouge">rbenv install</code> which simplifies the install process for new Ruby versions (which we will surely need for Rails 6)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2 
trackerr-user$ git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
</code></pre></div></div>

<p>Now you’ll be able to see all the available ruby versions with this command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ rbenv install -l
</code></pre></div></div>

<p>For Rails 6, we need Ruby 2.5.0 or newer. At the time of writing, Rails 6 sets it at 2.5.1</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2 
trackerr-user$ rbenv install 2.5.1
</code></pre></div></div>

<p>The installation may take some time. This is a good spot to make some coffee.</p>

<p>Up next, set your global default ruby version using</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2 
trackerr-user$ rbenv global 2.5.1
</code></pre></div></div>

<p>You can check with</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2 
trackerr-user$ ruby -v
</code></pre></div></div>

<p>Now we need to configure our ability to work with gems. First, let’s turn off local documentation generation by setting our ~/.gemrc to turn off that feature.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2 
trackerr-user$ echo "gem: --no-document" &gt; ~/.gemrc
</code></pre></div></div>

<p>Install bundler, which we’ll use often.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2 
trackerr-user$ gem install bundler 
</code></pre></div></div>

<p>Alright, this next part will feel somewhat familiar. We’re going to go ahead and install Rails 6, <em>but this time, on the EC2 server</em>.</p>

<p>So again:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ gem install rails --pre 
</code></pre></div></div>

<p>Since we installed a gem (Rails) which provides commands (which Rails does, and many other gems), we need to <code class="highlighter-rouge">rehash</code> our rbenv. Do this every time you install a <strong>gem that installs commands</strong>. You do not need to do this for gems without command line interfaces.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2 
trackerr-user$ rbenv rehash
</code></pre></div></div>

<h2 id="install-a-javascript-runtime-on-ec2">Install a Javascript Runtime on EC2</h2>

<p>The Rails Asset Pipeline requires JavaScript runtime, so let’s get Node.js</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ sudo add-apt-repository ppa:chris-lea/node.js
</code></pre></div></div>

<p>Then update apt-get and install the Node.js package:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2 
trackerr-user$ sudo apt-get update
trackerr-user$ sudo apt-get install nodejs
</code></pre></div></div>

<h2 id="install-a-node-package-manager">Install a Node package manager</h2>

<p>With Node installed, we’ll want to download the <a href="https://yarnpkg.com/en/">yarn</a> package manager, since Rails 6 uses it by default.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
trackerr-user$ echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
trackerr-user$ sudo apt-get update
trackerr-user$ sudo apt-get install yarn
</code></pre></div></div>

<p>For the purposes of this test, we’re going to use SQLite3 as a database, to avoid having to deal with postgres in our sandbox. This is a free tier EC2 instance and the Rails 6 beta, so I can’t imagine your target here is to set up a production-level app which requires a serious database. When we beef up the application in future blog posts, we’ll include information about setting up production-ready databases. <strong>Do not use SQLite as a production database</strong>.</p>

<h2 id="install-your-rails-app-on-ec2">Install your Rails App on EC2</h2>

<p>Now let’s get our project!</p>

<p>If you’re using SSH keys to access your GitHub account, you’ll need to set up those credentials on your server. You can do this by following the guide at <a href="https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/">here</a>, or you can follow along with me.</p>

<p>Basically, you’ll run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
</code></pre></div></div>

<p>You’ll be prompted for a file to save the key in, choose <strong>Enter</strong> to select the default location.</p>

<p>You’ll be given an option to type a secure passphrase, but it’s optional, and I usually don’t.</p>

<p>Now you can go to <code class="highlighter-rouge">~/.ssh</code> and run <code class="highlighter-rouge">vim id_rsa.pub</code></p>

<p>Copy that file, go to GitHub, click on <strong>Settings</strong>, then click <strong>SSH and GPG keys</strong>. Click <strong>New SSH key</strong> or <strong>Add SSH Key</strong>.</p>

<p>Select a title, then paste you rkey into the key field.</p>

<p>Click <strong>Add SSH Key</strong> and confirm your password at the prompt.</p>

<p>On your EC2 instance, from the folder above where you want your rails app to live, run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ git clone git@github.com:&lt;YOUR REPO HERE&gt; trackerr
</code></pre></div></div>

<p>Now you can change into the project directory and do some set up.</p>

<p>You’ll have to set up master.key. Master.key is a nifty credentials setup from Rails 5.2+</p>

<p><a href="https://medium.com/cedarcode/rails-5-2-credentials-9b3324851336">Here’s a bit more about it</a></p>

<p>Since we control this server, we can manually add the file ourselves.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ cd ~/trackerr/config
trackerr-user$ vim master.key
</code></pre></div></div>

<p>On your local machine (where you have a copy of master.key), grab that key, copy it, and put it in the <code class="highlighter-rouge">master.key</code> file on the server. This will give you access to the secrets file as detailed in the article on master.key</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2 
trackerr-user$ cd ~/trackerr
trackerr-user$ bundle install 
trackerr-user$ yarn
trackerr-user$ RAILS_ENV=production bundle exec rake db:create 
trackerr-user$ RAILS_ENV production rake db:migrate 
</code></pre></div></div>

<p><strong>Note:</strong> I hit a snag here on <code class="highlighter-rouge">bundle install</code>. When I changed into the directory and ran <code class="highlighter-rouge">bundle install</code>, I got an error that looked like</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>can't find gem bundler (&gt;= 0.a) with executable bundle (Gem::GemNotFoundException)
</code></pre></div></div>

<p>Your exact output may vary, but if you see something similar, this is because the bundler version on EC2 is different than that of the bundler version on your local machine.</p>

<p>You can check the Gemfile.lock file for what version of Bundler created the lock file. It’s at the bottom.</p>

<p>In my case, I had Bundler 2.0.0 installed on EC2, but the Gemfile.lock file had been created with 1.17.1.</p>

<p>I ran <code class="highlighter-rouge">gem install bundler -v 1.17.1</code> then <code class="highlighter-rouge">rbenv rehash</code> (remember? Since bundler adds commands, we need to rehash our rbenv). I tried <code class="highlighter-rouge">bundle install</code> again and it worked.</p>

<p>Or rather, it almost worked. I had forgotten to install sqlite3 on the server as well, so I ran into an error during bundler install. Ruby was very generous and gave me the command to run: <code class="highlighter-rouge">apt-get install libsqlite3-dev</code>.</p>

<p>So in the same directory, I ran:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ sudo apt-get install libsqlite3-dev
</code></pre></div></div>

<p>I ran <code class="highlighter-rouge">bundle install</code> once more, and everything came together.</p>

<p>I could have re-written this guide, but I wanted to include a common error (I have made this bundler mistake… multiple times) and demonstrate that even people who write guides about web development are not infallible, despite what some folks seem to say.</p>

<p>If you’ve had to troubleshoot like I did, here’s a re-cap of the commands you should run now htat you’ve fixed your errors. Don’t worry if you did successfully run these before and are running them again, all of them are fine to duplicate. May as well just give it a go.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ cd ~/trackerr
trackerr-user$ bundle install 
trackerr-user$ yarn
trackerr-user$ RAILS_ENV=production bundle exec rake db:create 
trackerr-user$ RAILS_ENV=production rake db:migrate 
</code></pre></div></div>

<p>You’ll notice we set RAILS_ENV to production there twice. We don’t want to have to do that every time (or worse - forget we have to do that everytime). So let’s add it to our bash profile.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ vim ~/.bashrc
</code></pre></div></div>

<p>And add <code class="highlighter-rouge">export RAILS_ENV="production"</code> to the bottom of your file.</p>

<p>Go ahead and restart bash by running <code class="highlighter-rouge">bash</code>. Now check your env variables with <code class="highlighter-rouge">printenv</code> and make sure <code class="highlighter-rouge">RAILS_ENV="production"</code> appears somewhere there.</p>

<p>Now we need to configure Unicorn and Nginx, we’ll be following the guide at [https://www.digitalocean.com/community/tutorials/how-to-deploy-a-rails-app-with-unicorn-and-nginx-on-ubuntu-14-04] from the <strong>Install Unicorn</strong> section down. We don’t need the beginning of that article, since we’ve done much of that already.</p>

<p>This is a great example of making changes to our app on a local machine and having them take effect on the server.</p>

<p>We need to add the unicorn gem to our gemfile, so on your local machine, add a gemfile group for production. I like to put it under the block that reads something like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/dev/trackerr/Gemfile
group :test do
...
end
</code></pre></div></div>

<p>I then add:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/dev/trackerr/Gemfile
group :production do
    gem 'unicorn'
end
</code></pre></div></div>

<p>And since we’re loading unicorn specifically in production, it pays to be explicit about when to load puma (the default server set up in rails 6).</p>

<p>I move the <code class="highlighter-rouge">gem 'puma', '~&gt; 3.11'</code> line to the block which looks like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/dev/trackerr/Gemfile
group: development, :test do
    ...
end
</code></pre></div></div>

<p>Now check that there aren’t any errors in development, and run</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/dev/trackerr
local$ bundle install
local$ rails s
</code></pre></div></div>

<p>Make sure your new gemfile didn’t throw any errors, and that Puma still boots up on your development machine.</p>

<p>If that’s in order, let’s configure Unicorn in anticipation of running it on the server.</p>

<p>On your development machine, add a file to the rails app at <code class="highlighter-rouge">~/dev/trackerr/config/unicorn.rb</code></p>

<p>For now, let’s just use the standard config DigitalOcean lists:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/dev/trackerr/config/unicorn.rb
# set path to application
app_dir = File.expand_path("../..", __FILE__)
shared_dir = "#{app_dir}/shared"
working_directory app_dir

# Set unicorn options
worker_processes 2
preload_app true
timeout 30

# Set up socket location
listen "#{shared_dir}/sockets/unicorn.sock", :backlog =&gt; 64

# Logging
stderr_path "#{shared_dir}/log/unicorn.stderr.log"
stdout_path "#{shared_dir}/log/unicorn.stdout.log"

# Set master PID location
pid "#{shared_dir}/pids/unicorn.pid"
</code></pre></div></div>

<p>Save the file. Commit it to git:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/dev/trackerr
local$ git add .
local$ git commit -m "add unicorn configuration"
local$ git push 
</code></pre></div></div>

<p>Now I’ve got the gemfile and required folders set up for Unicorn to run, and it’s in my repository.</p>

<p>You’ll notice the second command created some placeholder tx files in our <code class="highlighter-rouge">shared/</code> folders - this is because</p>

<p>To get these changes on the server, run:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/trackerr
trackerr-user$ cd ~/trackerr
trackerr-user$ git pull
</code></pre></div></div>

<p>When we created the Unicorn config, we set up the file to point to some folders which don’t exist yet, so let’s make those.</p>

<p>Make three new folders in the root of your app. So for me, I’m going to create</p>

<p><code class="highlighter-rouge">trackerr/shared/pids</code></p>

<p><code class="highlighter-rouge">trackerr/shared/sockets</code></p>

<p><code class="highlighter-rouge">trackerr/shared/log</code></p>

<p>By running:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ~/trackerr
trackerr-user$ mkdir -p shared/
</code></pre></div></div>

<p>Now run a <code class="highlighter-rouge">bundle install</code> on EC2 (this may take a bit, Unicorn is somewhat big).</p>

<p>Next, we’ll need to create a Unicorn Init Script <strong>on the EC2 server</strong> - it allows us to start and stop Unicorn, and ensure that it starts on boot.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2 
trackerr-user$ sudo vim /etc/init.d/unicorn_trackerr
</code></pre></div></div>

<p>You’ll want to copy this verbatim, but change the lines</p>

<p><code class="highlighter-rouge">USER="trackerr-user"</code></p>

<p>and</p>

<p><code class="highlighter-rouge">APP_NAME="trackerr"</code></p>

<p>To your user and app name, if you aren’t using <code class="highlighter-rouge">trackerr-user</code> and <code class="highlighter-rouge">trackerr</code>, respectively.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="c">### BEGIN INIT INFO</span>
<span class="c"># Provides:          unicorn</span>
<span class="c"># Required-Start:    $all</span>
<span class="c"># Required-Stop:     $all</span>
<span class="c"># Default-Start:     2 3 4 5</span>
<span class="c"># Default-Stop:      0 1 6</span>
<span class="c"># Short-Description: starts the unicorn app server</span>
<span class="c"># Description:       starts unicorn using start-stop-daemon</span>
<span class="c">### END INIT INFO</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="nv">USAGE</span><span class="o">=</span><span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> &lt;start|stop|restart|upgrade|rotate|force-stop&gt;"</span>

<span class="c"># app settings</span>
<span class="nv">USER</span><span class="o">=</span><span class="s2">"trackerr-user"</span>
<span class="nv">APP_NAME</span><span class="o">=</span><span class="s2">"trackerr"</span>
<span class="nv">APP_ROOT</span><span class="o">=</span><span class="s2">"/home/</span><span class="nv">$USER</span><span class="s2">/</span><span class="nv">$APP_NAME</span><span class="s2">"</span>
<span class="nv">ENV</span><span class="o">=</span><span class="s2">"production"</span>

<span class="c"># environment settings</span>
<span class="nv">PATH</span><span class="o">=</span><span class="s2">"/home/</span><span class="nv">$USER</span><span class="s2">/.rbenv/shims:/home/</span><span class="nv">$USER</span><span class="s2">/.rbenv/bin:</span><span class="nv">$PATH</span><span class="s2">"</span>
<span class="nv">CMD</span><span class="o">=</span><span class="s2">"cd </span><span class="nv">$APP_ROOT</span><span class="s2"> &amp;&amp; /home/trackerr-user/.rbenv/shims/bundle exec unicorn -c config/unicorn.rb -E production -D"</span>
<span class="nv">PID</span><span class="o">=</span><span class="s2">"</span><span class="nv">$APP_ROOT</span><span class="s2">/shared/pids/unicorn.pid"</span>
<span class="nv">OLD_PID</span><span class="o">=</span><span class="s2">"</span><span class="nv">$PID</span><span class="s2">.oldbin"</span>

<span class="c"># make sure the app exists</span>
<span class="nb">cd</span> <span class="nv">$APP_ROOT</span> <span class="o">||</span> <span class="nb">exit </span>1

sig <span class="o">()</span> <span class="o">{</span>
  <span class="nb">test</span> <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$PID</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> -<span class="nv">$1</span> <span class="sb">`</span><span class="nb">cat</span> <span class="nv">$PID</span><span class="sb">`</span>
<span class="o">}</span>

oldsig <span class="o">()</span> <span class="o">{</span>
  <span class="nb">test</span> <span class="nt">-s</span> <span class="nv">$OLD_PID</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> -<span class="nv">$1</span> <span class="sb">`</span><span class="nb">cat</span> <span class="nv">$OLD_PID</span><span class="sb">`</span>
<span class="o">}</span>

<span class="k">case</span> <span class="nv">$1</span> <span class="k">in
  </span>start<span class="p">)</span>
    sig 0 <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="s2">"Already running"</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0
    <span class="nb">echo</span> <span class="s2">"Starting </span><span class="nv">$APP_NAME</span><span class="s2">"</span>
    su - <span class="nv">$USER</span> <span class="nt">-c</span> <span class="s2">"</span><span class="nv">$CMD</span><span class="s2">"</span>
    <span class="p">;;</span>
  stop<span class="p">)</span>
    <span class="nb">echo</span> <span class="s2">"Stopping </span><span class="nv">$APP_NAME</span><span class="s2">"</span>
    sig QUIT <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0
    <span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="s2">"Not running"</span>
    <span class="p">;;</span>
  force-stop<span class="p">)</span>
    <span class="nb">echo</span> <span class="s2">"Force stopping </span><span class="nv">$APP_NAME</span><span class="s2">"</span>
    sig TERM <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0
    <span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="s2">"Not running"</span>
    <span class="p">;;</span>
  restart|reload|upgrade<span class="p">)</span>
    sig USR2 <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"reloaded </span><span class="nv">$APP_NAME</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0
    <span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="s2">"Couldn't reload, starting '</span><span class="nv">$CMD</span><span class="s2">' instead"</span>
    <span class="nv">$CMD</span>
    <span class="p">;;</span>
  rotate<span class="p">)</span>
    sig USR1 <span class="o">&amp;&amp;</span> <span class="nb">echo </span>rotated logs OK <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0
    <span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="s2">"Couldn't rotate logs"</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>1
    <span class="p">;;</span>
  <span class="k">*</span><span class="p">)</span>
    <span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="nv">$USAGE</span>
    <span class="nb">exit </span>1
    <span class="p">;;</span>
<span class="k">esac</span>
</code></pre></div></div>

<p>Update the script’s permissions and enable Unicorn to start on boot:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ sudo chmod 755 /etc/init.d/unicorn_trackerr
trackerr-user$ sudo update-rc.d unicorn_trackerr defaults
</code></pre></div></div>

<p>We can finally start unicorn by running:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2 
trackerr-user$ sudo service unicorn_trackerr start
</code></pre></div></div>

<p>Now Unicorn is running, but we can’t access it from the internet at large until we configure Nginx</p>

<p>Set up NGINX</p>

<p>We’re going to install and configure Nginx on our server now.</p>

<p>Head back to your home directory and install nginx.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2 
trackerr-user$ sudo apt-get install nginx
</code></pre></div></div>

<p>Next, let’s configure the default server block:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ sudo vim /etc/nginx/sites-available/default
</code></pre></div></div>

<p>Add the following, but replace the username and application name with yours.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>upstream app {
    # Path to Unicorn SOCK file, as defined previously
    server unix:/home/trackerr-user/trackerr/shared/sockets/unicorn.sock fail_timeout=0;
}

server {
    listen 80;
    server_name localhost;

    root /home/trackerr-user/trackerr/public;

    try_files $uri/index.html $uri @app;

    location @app {
        proxy_pass http://app;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_redirect off;
    }

    error_page 500 502 503 504 /500.html;
    client_max_body_size 4G;
    keepalive_timeout 10;
}
</code></pre></div></div>

<p>Save and exit. This configures Nginx as a reverse proxy, so HTTP requests get forwarded to the Unicorn application server via a Unix socket. Feel free to make any changes as you see fit. <strong>Make sure you overwrite the default config. The first time I did this, I just appended to the file, and I coudln’t figure out what was going wrong.</strong></p>

<p>Restart Nginx:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># EC2
trackerr-user$ sudo service nginx restart 
</code></pre></div></div>

<p>Awesome, now check it out at your Amazon IP address.</p>

<p>Head back to your EC2 Resource console, and find the value listed under Public DNS (IPv4) - then paste that into your browser.</p>

<p>You should be good to go! Congrats! You did it!</p>

<p>This post has been pretty long, but I hope you found it helpful. Again, this was a pretty limited scope and just covered how to get a new Rails 6 application up and running on a plain Amazon EC2 instance - no more.</p>

<p>I’ll be documenting the development of the Trackerr app on my blog here, and up next I plan to:</p>

<ol>
  <li>Set up an easier way to deploy changes to the app on the server.</li>
  <li>Set up a production-level database for the application.</li>
  <li>Configure the DNS settings for the application.</li>
  <li>Actually build the application.</li>
</ol>

  </div><a class="u-url" href="/blog/tutorial/rails/aws/2019/01/30/how-do-i-deploy-a-rails-6-app-to-amazon-ec-2.html" hidden></a>
</article>

      </div>
    </main>

  </body>

</html>
